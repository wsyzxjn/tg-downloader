# AGENTS.md

## é¡¹ç›®æ¦‚è§ˆ
- é¡¹ç›®å: `tg-downloader`
- ç›®æ ‡: é€šè¿‡ Telegram Bot + User API ä¸‹è½½åª’ä½“æ–‡ä»¶ï¼Œæä¾› Bot äº¤äº’å’Œ Web æ§åˆ¶å°ã€‚
- æœåŠ¡å½¢æ€: Hono API + Grammy Bot + React/Vite Web æ§åˆ¶å°ã€‚
- è¿è¡Œç¯å¢ƒ: Node.js `>=24`, pnpm `>=10`ã€‚

## ç›®å½•ç»“æ„
- `src/`: åç«¯ä¸ Bot ä¸»ä½“
- `src/api/`: Hono APIï¼ˆé…ç½®ã€ä»»åŠ¡ã€Web ç™»å½•è®¤è¯ã€Telegram ç™»å½•ã€SSEï¼‰
- `src/bot/`: Bot å¯åŠ¨ä¸è£…é…ï¼ˆç”Ÿå‘½å‘¨æœŸã€å‘½ä»¤/å›è°ƒæ³¨å†Œã€è¯­è¨€ï¼‰
- `src/services/`: æ ¸å¿ƒä¸šåŠ¡ï¼ˆé…ç½®ç¼“å­˜ã€é…ç½®å†™å…¥ç®¡ç†ã€ä»»åŠ¡é˜Ÿåˆ—ã€ä¸‹è½½ã€æ¥æºè§£æã€Bot ä»»åŠ¡è¿›åº¦ã€Web è®¤è¯ã€Telegram è®¤è¯ï¼‰
- `src/middlewares/`: Bot ä¸­é—´ä»¶ï¼ˆé‰´æƒã€é™„ä»¶ä¸‹è½½ã€é“¾æ¥ä¸‹è½½ï¼‰
- `web/`: React + Vite å‰ç«¯æ§åˆ¶å°
- `web/src/pages/`: è·¯ç”±é¡µé¢ï¼ˆ`/init`ã€`/login`ã€`/tasks`ã€`/settings`ï¼‰
- `web/src/components/app/`: åº”ç”¨çº§å¸ƒå±€ä¸å¯¼èˆªç»„ä»¶
- `web/src/hooks/`: å‰ç«¯æµç¨‹ç¼–æ’ï¼ˆåˆå§‹åŒ–ã€é‰´æƒå®ˆå«ã€ä»»åŠ¡æ“ä½œã€SSE/è½®è¯¢ç­‰ï¼‰

## å…³é”®è¡Œä¸ºçº¦å®š
- ä¸‹è½½èƒ½åŠ›:
  - æ”¯æŒå•æ¶ˆæ¯æ–‡ä»¶ä¸‹è½½ã€‚
  - æ”¯æŒåª’ä½“ç»„ï¼ˆalbumï¼‰ä¸€æ¬¡ä¸‹è½½å…¨éƒ¨å¯ä¸‹è½½æ–‡ä»¶ï¼ˆæŒ‰ `groupedId` èšåˆï¼‰ã€‚
  - ä¸‹è½½å‰æŒ‰ `setting.mediaTypes` è¿‡æ»¤å¯ä¸‹è½½åª’ä½“ç±»å‹ã€‚
- ä»»åŠ¡æ¨¡å‹:
  - å•ä»»åŠ¡å¯åŒ…å«å¤šæ–‡ä»¶ç»“æœã€‚
  - `result.filePath/fileName` ä¿æŒå…¼å®¹ï¼ˆé¦–æ–‡ä»¶/æ‘˜è¦ï¼‰ã€‚
  - å¤šæ–‡ä»¶å­—æ®µä½¿ç”¨ `result.filePaths/fileNames`ã€‚
- ä»»åŠ¡é˜Ÿåˆ—:
  - ä»»åŠ¡åœ¨å†…å­˜ä¸­ç®¡ç†ï¼Œ`pending -> running -> completed/failed/canceled`ã€‚
  - æœ€å¤šå¹¶å‘è¿è¡Œ `3` ä¸ªä»»åŠ¡ï¼ˆ`MAX_CONCURRENT_RUNNING_TASKS`ï¼‰ã€‚
  - å·²ç»“æŸä»»åŠ¡é»˜è®¤ä¿ç•™ `24h`ï¼Œåˆ°æœŸåä»ä»»åŠ¡åˆ—è¡¨æ¸…ç†å¹¶æ¨é€ `remove` äº‹ä»¶ã€‚
- ä»»åŠ¡è¿›åº¦:
  - Web ç«¯ä¼˜å…ˆä½¿ç”¨ SSE (`/api/tasks/stream`)ã€‚
  - SSE æ¨é€äº‹ä»¶ä¸º `snapshot` ä¸ `task_update`ï¼ŒæœåŠ¡ç«¯æœ‰ keepalive å¿ƒè·³ã€‚
  - SSE æ–­å¼€æ—¶å‰ç«¯è‡ªåŠ¨é‡è¿ï¼Œå¹¶å…ˆè§¦å‘ä¸€æ¬¡å…¨é‡ä»»åŠ¡æ‹‰å–å…œåº•ã€‚
  - è‹¥è¿è¡Œç¯å¢ƒä¸æ”¯æŒ `EventSource`ï¼Œå‰ç«¯é™çº§ä¸º 2 ç§’è½®è¯¢ã€‚
- Bot è¿›åº¦:
  - ç”±ä»»åŠ¡äº‹ä»¶é©±åŠ¨ï¼ˆ`task-service` å‘å¸ƒäº‹ä»¶ï¼Œ`bot-task-progress-service` è®¢é˜…å¹¶æ›´æ–°æ¶ˆæ¯ï¼‰ã€‚
  - è¿›åº¦è¡Œæ ¼å¼ä¸ºâ€œè¿›åº¦æ¡ + ç™¾åˆ†æ¯”â€åŒä¸€è¡Œï¼ˆ`ğŸ“Š [â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘] 35%`ï¼‰ã€‚
  - å–æ¶ˆç¡®è®¤é˜¶æ®µä¼šæš‚åœè¯¥ä»»åŠ¡çš„è¿›åº¦æ¶ˆæ¯åˆ·æ–°ï¼Œé¿å…ç¡®è®¤æŒ‰é’®è¢«è¦†ç›–ã€‚
  - ä»»åŠ¡å˜ä¸º `canceled` æ—¶ï¼ŒBot è¿›åº¦æ¶ˆæ¯ä¼šè¢«åˆ é™¤ã€‚
- ä»»åŠ¡å–æ¶ˆ:
  - æ”¯æŒ Web API å–æ¶ˆä¸ Bot å†…è”æŒ‰é’®å–æ¶ˆã€‚
  - Bot ä¾§ä¸ºäºŒæ¬¡ç¡®è®¤æµç¨‹ï¼š`å–æ¶ˆä»»åŠ¡ -> ç¡®è®¤å–æ¶ˆ/è¿”å›`ã€‚
  - å–æ¶ˆåä»»åŠ¡çŠ¶æ€ä¿æŒä¸º `canceled`ï¼Œä¸ä¼šè¢«åç»­ä¸‹è½½å¼‚å¸¸è¦†ç›–æˆ `failed`ã€‚
  - å¯¹ `pending` ä»»åŠ¡å–æ¶ˆä¼šç§»é™¤æ‰§è¡Œè½½è·ï¼Œé¿å…ä»»åŠ¡åç»­è¿›å…¥ä¸‹è½½æµç¨‹ã€‚
  - è‹¥ä»»åŠ¡ç”± Bot å‘èµ·ï¼ŒWeb ç«¯å–æ¶ˆæ—¶ä¹Ÿä¼šè§¦å‘åˆ é™¤ Bot è¿›åº¦æ¶ˆæ¯ï¼ˆç”±äº‹ä»¶è®¢é˜…æ–¹ç»Ÿä¸€å¤„ç†ï¼‰ã€‚
- Bot å›è°ƒå¤„ç†:
  - callback query ç›¸å…³è·¯å¾„ä½¿ç”¨å®‰å…¨åº”ç­”ï¼ˆåº”ç­”å¤±è´¥ä¼šè®°å½•æ—¥å¿—ï¼Œä¸é˜»æ–­ä¸»æµç¨‹ï¼‰ã€‚
  - åŒä¸€æ¥æºæ¶ˆæ¯ï¼ˆ`sourceKey`ï¼‰è‹¥å·²æœ‰ `pending/running` ä»»åŠ¡ï¼Œä¼šæ‹’ç»é‡å¤åˆ›å»ºä»»åŠ¡ã€‚
- Web é‰´æƒ:
  - æ”¯æŒå¯é€‰ Web ç™»å½•ï¼ˆ`webUsername` + `webPassword`ï¼‰ã€‚
  - å½“ Web ç™»å½•å·²é…ç½®æ—¶ï¼Œ`/api/*` é»˜è®¤éœ€è¦ cookie ä¼šè¯ï¼ˆå…¬å…±è·¯å¾„é™¤å¤–ï¼‰ã€‚
  - ä¼šè¯ä¿å­˜åœ¨å†…å­˜ï¼Œé»˜è®¤æœ‰æ•ˆæœŸ 7 å¤©ã€‚
- Bot é‡å¯æ¢å¤:
  - Bot åœæ­¢/é‡å¯æ—¶ä¼šå–æ¶ˆæ¥æºä¸º `bot_message:*` çš„æ´»åŠ¨ä»»åŠ¡ï¼Œé¿å…å‡ºç°æ— ç»‘å®šè¿›åº¦æ¶ˆæ¯çš„æ‚¬æŒ‚ä»»åŠ¡ã€‚
- æ—¥å¿—:
  - æ—¥å¿—çº§åˆ«æ”¯æŒ `debug|info|warn|error`ã€‚
  - å¯åŠ¨åˆå§‹çº§åˆ«ç”± `LOG_LEVEL` ç¯å¢ƒå˜é‡å†³å®šï¼ˆæœªè®¾ç½®æ—¶ç­‰æ•ˆ `error`ï¼‰ã€‚
  - é…ç½®åŠ è½½åä¼šä½¿ç”¨ `setting.logLevel`ï¼ˆé»˜è®¤å›è½ `info`ï¼‰ã€‚
  - æ—¥å¿—å†™å…¥ `log/YYYY-MM-DD.log`ï¼Œé»˜è®¤ä¿ç•™ 7 å¤©ã€‚

## å¼€å‘å‘½ä»¤

### åç«¯ï¼ˆæ ¹ç›®å½•ï¼‰
- å¼€å‘: `pnpm run dev`
- æ„å»º: `pnpm run build`ï¼ˆåç«¯ `tsup` + å‰ç«¯ `web build`ï¼‰
- å¯åŠ¨æ„å»ºäº§ç‰©: `pnpm run start`
- ç±»å‹æ£€æŸ¥: `pnpm run type-check`
- ä»£ç æ£€æŸ¥: `pnpm run check`ï¼ˆç­‰åŒ `pnpm run lint`ï¼‰
- è‡ªåŠ¨ä¿®å¤: `pnpm run fix`
- æ ¼å¼åŒ–: `pnpm run format`
- è¯´æ˜: æ ¹ç›®å½• `check` å½“å‰åªæ ¡éªŒåç«¯ `src`ï¼ˆ`biome check src`ï¼‰ã€‚

### å‰ç«¯ï¼ˆwebï¼‰
- å¼€å‘: `pnpm -C web run dev`
- æ„å»º: `pnpm -C web run build`
- Lint: `pnpm -C web run lint`
- è‡ªåŠ¨ä¿®å¤: `pnpm -C web run fix`
- æ ¼å¼åŒ–: `pnpm -C web run format`

## ä»£ç è§„èŒƒ
- åç«¯:
  - ä½¿ç”¨ Biome è§„åˆ™ï¼Œæäº¤å‰è‡³å°‘é€šè¿‡ `pnpm run check` ä¸ `pnpm run type-check`ã€‚
  - æœåŠ¡å±‚ä¼˜å…ˆæ‰¿è½½ä¸šåŠ¡é€»è¾‘ï¼Œä¸­é—´ä»¶ä¸ API å±‚å°½é‡åšç¼–æ’ã€‚
- å‰ç«¯:
  - è·¯ç”±ä½¿ç”¨ `react-router-dom`ï¼Œå½“å‰é¡µé¢ä¸º `/init`ã€`/login`ã€`/tasks`ã€`/settings`ã€‚
  - ç»„ä»¶è´Ÿè´£å±•ç¤ºï¼Œå¤æ‚çŠ¶æ€ä¸å‰¯ä½œç”¨ä¼˜å…ˆæ”¾åœ¨ hooksã€‚
  - æäº¤å‰è‡³å°‘é€šè¿‡ `pnpm -C web run lint` ä¸ `pnpm -C web run build`ã€‚

## å˜æ›´å»ºè®®
- æ–°å¢ä¸‹è½½èƒ½åŠ›æ—¶ï¼Œä¼˜å…ˆä¿®æ”¹ `src/services/media-downloader.ts`ï¼Œå¹¶ä¿æŒä»»åŠ¡ç»“æœå­—æ®µå…¼å®¹ã€‚
- æ–°å¢ä»»åŠ¡çŠ¶æ€ã€äº‹ä»¶æˆ–é˜Ÿåˆ—è§„åˆ™æ—¶ï¼ŒåŒæ­¥æ›´æ–°:
  - `src/services/task-service.ts`
  - `src/api/app.ts`ï¼ˆSSE æ¨é€ç»“æ„ï¼‰
  - `web/src/types/app.ts`
  - `web/src/hooks/use-task-actions.ts` / `web/src/hooks/use-app-effects.ts`
- æ–°å¢/è°ƒæ•´å–æ¶ˆä»»åŠ¡è¡Œä¸ºæ—¶ï¼ŒåŒæ­¥æ£€æŸ¥:
  - `src/services/task-service.ts`ï¼ˆ`cancelTask` ä¸çŠ¶æ€æµè½¬ï¼‰
  - `src/services/bot-task-progress-service.ts`ï¼ˆè¿›åº¦æ¶ˆæ¯åˆ·æ–°ã€æš‚åœä¸åˆ é™¤ï¼‰
  - `src/bot/create-bot-instance.ts`ï¼ˆå›è°ƒæŒ‰é’®ä¸äºŒæ¬¡ç¡®è®¤ï¼‰
- æ–°å¢/è°ƒæ•´ Web ç™»å½•é‰´æƒè¡Œä¸ºæ—¶ï¼ŒåŒæ­¥æ£€æŸ¥:
  - `src/services/web-auth-service.ts`ï¼ˆå‡­æ®ä¸ä¼šè¯ï¼‰
  - `src/api/app.ts`ï¼ˆé‰´æƒä¸­é—´ä»¶ä¸ç™»å½•æ¥å£ï¼‰
  - `web/src/services/api.ts` ä¸ `web/src/hooks/use-app-effects.ts`ï¼ˆç™»å½•æ€è·å–ä¸è·¯ç”±å®ˆå«ï¼‰
  - `web/src/pages/login.tsx`ï¼ˆç™»å½•é¡µé¢äº¤äº’ï¼‰
- æ–°å¢/è°ƒæ•´é…ç½®åˆå§‹åŒ–æˆ–æ›´æ–°è¡Œä¸ºæ—¶ï¼ŒåŒæ­¥æ£€æŸ¥:
  - `src/services/setting-management-service.ts`ï¼ˆé…ç½®æ ¡éªŒä¸æŒä¹…åŒ–å†™å…¥ï¼‰
  - `src/services/config-service.ts`ï¼ˆé…ç½®è¯»å–ç¼“å­˜ä¸å˜æ›´é€šçŸ¥ï¼‰
  - `src/api/app.ts`ï¼ˆé…ç½® API å…¥å‚ä¸å“åº”ï¼‰
- æ”¹åŠ¨ UI æ—¶ï¼Œé¿å…ç ´ååˆå§‹åŒ–æµç¨‹ä¸ç™»å½•å®ˆå«é€»è¾‘ï¼ˆ`/init`ã€`/login`ã€`/tasks`ã€`/settings`ï¼‰ã€‚
